<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chat With US</title>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300&display=swap"
            rel="stylesheet"
        />

        <style>
        * {
            font-family: 'Noto Sans Thai', sans-serif;
        }

        .page-title {
            text-align: center;
            font-size: 2rem;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            height: 90vh;
            width: 90%;
            margin: 0 auto;
        }

        .chat-messages {
            flex: 1;
            overflow-y: scroll;
        }

        .message {
            background-color: #f1f0f0;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .message .meta {
            font-size: 0.8rem;
            color: #777;
        }

        .message .text {
            font-size: 1rem;
        }

        .my-message {
            background-color: #31983f;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            width: 70%;
            position: absolute;
            right: 5%;
        }

        .my-message .meta {
            font-size: 0.8rem;
            color: #fff;
        }

        .my-message .text {
            font-size: 1rem;
            color: #fff;
        }

        .admin-message {
            background-color: #7084bf;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            width: 70%;
            position: absolute;
            left: 5%;
        }

        .admin-message .meta {
            font-size: 0.8rem;
            color: #fff;
        }

        .admin-message .text {
            font-size: 1rem;
            color: #fff;
        }

        .chat-form {
            display: flex;
            margin-top: 10px;
        }

        .chat-form #name {
            padding: 0.5rem;
            margin-right: 0.25rem;
        }

        .chat-form #message {
            flex: 1;
            padding: 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #4e4bfc;
            margin-right: 0.5rem;
        }

        .chat-form button {
            background-color: #4e4bfc;
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 10px;
            cursor: pointer;
        }
        </style>
    </head>
    <body>
        <div class="chat-container">
        <h2 class="page-title">Chat With US</h2>

        <div class="chat-messages">

        </div>
        <form class="chat-form" id="form">
            <input type="text" id="message" />
            <button type="submit">Send</button>
        </form>
        </div>

        <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
        <script src="authorize.js"></script>
        <script>

            const form = document.getElementById('form')
            const message = document.getElementById('message')
            // initial email
            const email = getEmail(); 
            const token = getToken(); 

            const socket = io("http://localhost:8081",{transports:['websocket'],query: {
                token: token
            }});

            document.addEventListener("DOMContentLoaded", function() {
                // get previous chat from DB
                fetch("http://localhost:8081/chat/previous", {
                    method: "GET",
                    headers: {
                        Authorization: `Bearer ${token}`
                    },
                    cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                    redirect: 'follow', // manual, *follow, error
                    referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                })
                .then(response => response.json()) 
                .then(data => {
                    console.log(data);
                });
            });

            form.addEventListener('submit', (e) => {
                e.preventDefault()
                if (message.value) {
                    let formData = new FormData();
                    formData.append('message', message.value);
                    formData.append('time', new Date().toLocaleTimeString());
                    fetch("http://localhost:8081/chat", {
                        method: "POST",
                        headers: {
                            Authorization: `Bearer ${token}`
                        },
                        cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                        redirect: 'follow', // manual, *follow, error
                        referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                        body: formData,
                    })
                    .then(response => response.json()) 
                    .then(data => {
                        // console.log(data);
                    });
                    message.value = ''
                }
            })

            socket.on('chat:message', (data) => {
                const div = document.createElement('div')
                if(data.permission=='admin'){
                    div.classList.add('admin-message')
                }else{
                    div.classList.add('my-message')
                }
                div.innerHTML = `
                    <p class="meta">${data.name} <span>${data.time}</span></p>
                    <p class="text">${data.message}</p>
                `
                document.querySelector('.chat-messages').appendChild(div)
            })

            function getEmail() {
                let userEmail = getUserEmail();
                if(userEmail==false){
                    window.location.href = "index.html";
                }else{
                    return userEmail;
                }
            }
        </script>
    </body>
</html>
